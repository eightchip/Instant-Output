# サブスクリプション認証システム実装状況

## ✅ 完了

1. **設計ドキュメント作成**
   - `SUBSCRIPTION_AUTH_DESIGN.md`: 全体設計

2. **データモデル拡張**
   - `types/models.ts`: User, Subscription, UsageStats型を追加

3. **認証ライブラリ**
   - `lib/auth.ts`: クライアント側認証機能
   - `lib/auth-server.ts`: サーバー側認証機能（JWT、bcrypt）

4. **認証API（基本実装）**
   - `app/api/auth/signup/route.ts`: ユーザー登録
   - `app/api/auth/login/route.ts`: ログイン
   - `app/api/auth/me/route.ts`: ユーザー情報取得

## ⏳ 実装中・未実装

### 優先度: 高

1. **データベース統合**
   - [ ] サーバーDB（PostgreSQL/MySQL）のセットアップ
   - [ ] ユーザーテーブルの作成
   - [ ] サブスクリプションテーブルの作成
   - [ ] 使用量統計テーブルの作成

2. **認証APIの完成**
   - [ ] データベース連携の実装
   - [ ] エラーハンドリングの改善
   - [ ] バリデーションの強化

3. **サブスクリプション管理API**
   - [ ] `/api/subscription/plans`: プラン一覧
   - [ ] `/api/subscription/checkout`: Stripe統合
   - [ ] `/api/subscription/status`: サブスクリプション状態
   - [ ] `/api/subscription/webhook`: Stripe Webhook

4. **使用量トラッキング**
   - [ ] `/api/usage/track`: 使用量記録
   - [ ] 使用量統計の集計
   - [ ] プラン制限チェック

### 優先度: 中

5. **既存APIへの統合**
   - [ ] 各APIルートに認証ミドルウェアを追加
   - [ ] プラン制限チェックの実装
   - [ ] エラーメッセージの改善

6. **クライアント側UI**
   - [ ] サインアップ/ログイン画面
   - [ ] サブスクリプション選択画面
   - [ ] 使用量表示UI
   - [ ] アップグレード促進UI

### 優先度: 低

7. **追加機能**
   - [ ] パスワードリセット
   - [ ] メール認証
   - [ ] 二要素認証（オプション）

---

## 次のステップ

### 即座に実装すべき

1. **データベースの選択とセットアップ**
   - Vercel Postgres（推奨）またはMySQL
   - マイグレーションスクリプトの作成

2. **認証APIの完成**
   - データベース連携
   - テストの実装

3. **基本的なサブスクリプション管理**
   - プラン定義
   - 制限チェック機能

### 段階的実装

4. **Stripe統合**
   - テスト環境での実装
   - Webhook処理

5. **既存APIへの統合**
   - 段階的に各APIに認証を追加
   - 後方互換性の維持

---

## 注意事項

### セキュリティ
- JWT_SECRETは環境変数で管理（本番環境では強力な秘密鍵を使用）
- パスワードは必ずハッシュ化（bcrypt）
- HTTPS必須（本番環境）

### データベース
- 現在はIndexedDBベースの簡易実装
- 本番環境では必ずサーバーDBを使用
- データ移行計画が必要

### 後方互換性
- 既存の管理者認証は残す（開発・テスト用）
- 段階的な移行を推奨
